## Назначение

Краткие проектно-специфичные инструкции для AI-агентов, работающих с Metaterminal.
Фокус на практических паттернах, командах запуска/отладки и ключевых точках интеграции.

## Общее устройство (Big picture)
- **Точка входа:** `server.js` (корень проекта) — загружает сервер; основной модуль указан в `package.json`.
- **API:** `application/api/` содержит HTTP/WS-обработчики, организованные по группам (например, `auth.2`, `info.1`, `alpaca.2`). Числовой суффикс — внутренняя версия группы.
- **Общая логика:** `lib/` содержит переиспользуемые хелперы и адаптеры, используемые в обработчиках.
- **Конфигурация:** `config/*.js` содержит окружные привязки (база данных, кеш, Alpaca, сессии).
- **Статика:** `static/` содержит frontend-скрипты (например, `metacom.js`) и другие ресурсы.

## Важные файлы и места (примеры)
- `server.js` — инициализация приложения и middleware.
- `package.json` — скрипты и зависимости (используйте `npm run test`, `npm run lint`, `npm run fmt`, `npm run types`).
- `types/global.d.ts` и `tsconfig.json` — типизация проекта (TypeScript объявления для JS-кода).
- `application/api/*` — обработчики API; сохраняйте существующую схему именования и версионирования (`*.1`, `*.2`).
- `config/*.js` — подключение внешних сервисов (DB, Redis, Alpaca и т.д.).
- `lib/` — общие утилиты; предпочитайте переиспользование кода из `lib/`.

## Рабочие сценарии для разработчика (фактически работающие команды)
- Установить зависимости: `npm install`.
- Запустить сервер: `node server.js` (скрипта `start` нет; запуск напрямую через `server.js`).
- Прогнать тесты: `npm run test` — запускает `lint`, `tsc` и `node test/system.js`.
- Линт/формат: `npm run lint` и `npm run fmt`.
- Проверка типов: `npm run types` (использует `tsc` с `types/` и `tsconfig.json`).
- Работа с БД: `npm run db` выполняет `metasql c` (команды для управления базой данных).

В `package.json` в поле `engines` перечислены поддерживаемые версии Node: 16, 18, 19, 20 — используйте одну из них.

## Проектные соглашения и паттерны
- Именование API-групп: папки в `application/api/` часто имеют суффикс версии (например, `watchList.1/`). Сохраняйте суффикс при добавлении/миграции обработчиков.
- Большая часть кода — JavaScript; определения типов лежат в `types/`. При добавлении публичных форматов обновляйте `types/global.d.ts`.
- Адаптеры для внешних сервисов (DB, Redis, Alpaca) подключаются через `config/` и используются в `lib/`/`application/`.
- Основной интеграционный раннер тестов — `test/system.js` — изменения должны оставаться совместимыми с ним.

## Точки интеграции и внешние зависимости
- Alpaca: пакет `@alpacahq/alpaca-trade-api` — смотрите `application/api/alpaca.2/*` и `config/alpaca.js`.
- Потоковые данные: `market-data-tradingview-ws` и `ws` — обработчики стримов расположены в `application/api/` и могут ожидать специфичных форматов сообщений; также проверьте `static/`.
- БД и кеш: `pg` и `redis` — конфигурации в `config/database.js` и `config/sessions.js`.

## На что обращать внимание при редактировании/добавлении кода
- Сохраняйте имена и версии API-групп (не переименовывайте `*.1`/`*.2` без согласованной миграции).
- Обновляйте `types/global.d.ts`, если добавляете новые публичные структуры.
- Для новых внешних сервисов добавляйте хуки в `config/` и подключайте их из `lib/` или `application/`.
- Держите низкоуровневую логику в `lib/`, а конкретную логику эндпоинтов — в `application/api/`.

## Примеры быстрых задач (как действовать агенту)
- Добавить новый маршрут `foo`: создать `application/api/foo.1/handler.js`, при необходимости прописать конфиг в `config/*.js`, вынести общую логику в `lib/` и обновить `types/global.d.ts` если есть публичные типы.
- Запустить тесты локально: 
```
npm install
npm run test
```

## Где искать дополнительный контекст
- Просмотрите: `server.js`, `package.json`, `application/api/`, `lib/`, `config/`, `types/global.d.ts`.
