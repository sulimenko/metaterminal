name: Deploy Test System
on:
  push:
    tags:
      - "*"

jobs:
  deploy:
    if: contains(github.ref_name, '-')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Set package version from tag
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          npm version --no-git-tag-version "$VERSION"

      - name: Write build info
        shell: bash
        run: |
          GIT_HASH="$(git rev-parse HEAD)"
          VERSION="$(node -p "require('./package.json').version")"
          printf '{\n  "version": "%s",\n  "hash": "%s"\n}\n' "$VERSION" "$GIT_HASH" > build-info.json

      - name: Add SSH key (base64)
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.TEST_DEPLOY_SSH_KEY_B64 }}" | base64 -d > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/id_rsa

      - name: Trust host key
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ vars.TEST_DEPLOY_HOST }}" >> ~/.ssh/known_hosts

      - name: Show remote deploy directory
        run: |
          ssh "${{ vars.TEST_DEPLOY_USER }}@${{ vars.TEST_DEPLOY_HOST }}" "ls -la '${{ vars.TEST_DEPLOY_PATH }}'"

      - name: Sync source to server
        run: |
          rsync -az --delete \
            --exclude "/.github" \
            --exclude "/.vscode" \
            --exclude "/backup" \
            --exclude "/vendor" \
            --exclude "/node_modules" \
            --exclude "/docker-compose.override.yml" \
            --exclude "/.env" \
            ./ "${{ vars.TEST_DEPLOY_USER }}@${{ vars.TEST_DEPLOY_HOST }}:${{ vars.TEST_DEPLOY_PATH }}/"

      - name: Build and run on server
        run: |
          ssh "${{ vars.TEST_DEPLOY_USER }}@${{ vars.TEST_DEPLOY_HOST }}" "cd '${{ vars.TEST_DEPLOY_PATH }}' && docker compose build && docker compose up -d"
